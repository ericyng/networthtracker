{% extends 'dashboard/base.html' %}
{% load humanize %}
{% load dashboard_extras %}

{% block title %}Dashboard - NetWorth Tracker{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <a href="{% url 'dashboard:account_create' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i>Add Account
        </a>
    </div>
{% endblock %}

{% block content %}
    <!-- Welcome message for new users -->
    {% if not has_accounts %}
        <div class="alert alert-info" role="alert">
            <h4 class="alert-heading">Welcome to your Personal Finance Dashboard! ðŸŽ‰</h4>
            <p>You're all set up! To get started, add your first account to begin tracking your finances.</p>
            <hr>
            <p class="mb-0">
                <a href="{% url 'dashboard:account_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>Add Your First Account
                </a>
            </p>
        </div>
    {% endif %}

    <!-- Total Balance Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Total Balance</div>
                            <div class="h2 mb-0 font-weight-bold">${{ total_balance|floatformat:2|intcomma }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-wallet2 fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Balance Over Time Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>Total Balance Over Time
                    </h5>
                    <a href="{% url 'dashboard:account_entries' %}" class="btn btn-sm btn-outline-primary">Add/Edit Entries</a>
                </div>
                <div class="card-body">
                    {% if chart_data %}
                        <div class="row">
                            <div class="col-12">
                                <canvas id="balanceChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="text-center">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Shows total account balance for the last 12 months
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-graph-up display-4 text-muted"></i>
                            <p class="text-muted mt-2">No balance data available</p>
                            <p class="text-muted">Add account entries to see your balance over time</p>
                            <a href="{% url 'dashboard:account_entries' %}" class="btn btn-primary">
                                <i class="bi bi-calendar-plus me-1"></i>Add Account Entries
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Net Worth, Assets, and Debts Line Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up-arrow me-2"></i>Net Worth & Categories Over Time
                    </h5>
                    <a href="{% url 'dashboard:account_entries' %}" class="btn btn-sm btn-outline-primary">Add/Edit Entries</a>
                </div>
                <div class="card-body">
                    {% if line_chart_data %}
                        <div class="row">
                            <div class="col-12">
                                <canvas id="lineChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="text-center">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Shows net worth and breakdown by category (Cash, Equity & Investments, Retirement, Property, Debts, Other) for the last 12 months
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-graph-up-arrow display-4 text-muted"></i>
                            <p class="text-muted mt-2">No financial data available</p>
                            <p class="text-muted">Add account entries to see your net worth, assets, and debts over time</p>
                            <a href="{% url 'dashboard:account_entries' %}" class="btn btn-primary">
                                <i class="bi bi-calendar-plus me-1"></i>Add Account Entries
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Accounts Distribution Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart me-2"></i>Accounts Distribution
                    </h5>
                    <a href="{% url 'dashboard:accounts_list' %}" class="btn btn-sm btn-outline-primary">View All Accounts</a>
                </div>
                <div class="card-body">
                    {% if accounts %}
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="accountsChart" width="400" height="300"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="chart-legend">
                                    <h6 class="mb-3">Account Types</h6>
                                    <div id="chartLegend"></div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-pie-chart display-4 text-muted"></i>
                            <p class="text-muted mt-2">No accounts yet</p>
                            <a href="{% url 'dashboard:account_create' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-1"></i>Add Your First Account
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'dashboard:account_create' %}" class="btn btn-outline-primary w-100">
                                <i class="bi bi-bank me-2"></i>Add Account
                            </a>
                        </div>
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'dashboard:accounts_list' %}" class="btn btn-outline-info w-100">
                                <i class="bi bi-list-ul me-2"></i>View All Accounts
                            </a>
                        </div>
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'dashboard:account_entries' %}" class="btn btn-outline-success w-100">
                                <i class="bi bi-calendar-plus me-2"></i>Add/Edit Entries
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if chart_data %}
        // Prepare data for the bar chart
        const chartData = {
            labels: [
                {% for data in chart_data %}
                    '{{ data.month|escapejs }}'{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Total Balance',
                data: [
                    {% for data in chart_data %}
                        {{ data.balance }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                borderRadius: 4,
                borderSkipped: false,
            }]
        };

        // Create the bar chart
        const ctx = document.getElementById('balanceChart').getContext('2d');
        const balanceChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                return `Total Balance: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('en-US');
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    {% endif %}

    {% if line_chart_data %}
        // Prepare data for the line chart with categories
        const lineChartData = {
            labels: [
                {% for data in line_chart_data %}
                    '{{ data.month|escapejs }}'{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Net Worth',
                data: [
                    {% for data in line_chart_data %}
                        {{ data.net_worth }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }, {
                label: 'Cash',
                data: [
                    {% for data in line_chart_data %}
                        {{ data.cash }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }, {
                label: 'Equity & Investments',
                data: [
                    {% for data in line_chart_data %}
                        {{ data.equity_investments }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgba(34, 197, 94, 1)',
                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }, {
                label: 'Retirement',
                data: [
                    {% for data in line_chart_data %}
                        {{ data.retirement }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }, {
                label: 'Property',
                data: [
                    {% for data in line_chart_data %}
                        {{ data.property }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgba(245, 158, 11, 1)',
                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }, {
                label: 'Debts',
                data: [
                    {% for data in line_chart_data %}
                        {{ data.debts }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgba(239, 68, 68, 1)',
                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }, {
                label: 'Other',
                data: [
                    {% for data in line_chart_data %}
                        {{ data.other }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgba(107, 114, 128, 1)',
                backgroundColor: 'rgba(107, 114, 128, 0.2)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }]
        };

        // Create the line chart
        const lineCtx = document.getElementById('lineChart').getContext('2d');
        const lineChart = new Chart(lineCtx, {
            type: 'line',
            data: lineChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                return `${label}: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('en-US');
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    {% endif %}

    {% if accounts %}
        // Prepare data for the pie chart
        const accountData = {
            labels: [
                {% for account in accounts %}
                    '{{ account.name|escapejs }}'{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for account in accounts %}
                        {{ account.get_latest_balance }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384',
                    '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };

        // Create the pie chart
        const pieCtx = document.getElementById('accountsChart').getContext('2d');
        const accountsChart = new Chart(pieCtx, {
            type: 'pie',
            data: accountData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Create custom legend
        const legendContainer = document.getElementById('chartLegend');
        accountData.labels.forEach((label, index) => {
            const legendItem = document.createElement('div');
            legendItem.className = 'd-flex align-items-center mb-2';
            legendItem.innerHTML = `
                <div class="legend-color me-2" style="width: 12px; height: 12px; background-color: ${accountData.datasets[0].backgroundColor[index]}; border-radius: 2px;"></div>
                <div class="legend-text small">
                    <div class="fw-bold">${label}</div>
                    <div class="text-muted">$${accountData.datasets[0].data[index].toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
            `;
            legendContainer.appendChild(legendItem);
        });
    {% endif %}
});
</script>
{% endblock %} 